<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Private Forex Trading Platform</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <script>
        // Fallback loader for ethers.js
        window.addEventListener('DOMContentLoaded', function() {
            if (typeof ethers === 'undefined') {
                console.log('Loading fallback ethers.js...');
                const script = document.createElement('script');
                script.src = 'https://unpkg.com/ethers@5.7.2/dist/ethers.umd.min.js';
                script.onload = function() {
                    console.log('Fallback ethers.js loaded');
                    if (typeof init === 'function') init();
                };
                script.onerror = function() {
                    console.error('Failed to load ethers.js from all CDNs');
                };
                document.head.appendChild(script);
            }
        });
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #FFD700, #FFA500);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: rgba(255, 255, 255, 0.1);
            padding: 25px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card h3 {
            margin-bottom: 20px;
            color: #FFD700;
            font-size: 1.3em;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .input-group input, .input-group select {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 16px;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .input-group input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: #FFD700;
            box-shadow: 0 0 0 2px rgba(255, 215, 0, 0.3);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            background: linear-gradient(45deg, #FFD700, #FFA500);
            color: #000;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 16px;
            width: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 215, 0, 0.4);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: linear-gradient(45deg, #6c757d, #495057);
            color: white;
        }

        .status-card {
            grid-column: 1 / -1;
            text-align: center;
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .status-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .status-item strong {
            color: #FFD700;
            display: block;
            margin-bottom: 5px;
        }

        .currency-pairs {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }

        .pair-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .connected {
            color: #28a745;
        }

        .disconnected {
            color: #dc3545;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid;
        }

        .alert-success {
            background: rgba(40, 167, 69, 0.2);
            border-color: #28a745;
            color: #28a745;
        }

        .alert-error {
            background: rgba(220, 53, 69, 0.2);
            border-color: #dc3545;
            color: #dc3545;
        }

        .alert-info {
            background: rgba(23, 162, 184, 0.2);
            border-color: #17a2b8;
            color: #17a2b8;
        }

        .transaction-history {
            grid-column: 1 / -1;
            margin-top: 20px;
        }

        .transaction-list {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 15px;
        }

        .transaction-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #FFD700;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 2em;
            }

            .status-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Private Forex Trading Platform</h1>
            <p>Secure & Private Currency Trading with Fully Homomorphic Encryption</p>
        </div>

        <div id="alertContainer"></div>

        <div class="dashboard">
            <!-- Wallet Connection -->
            <div class="card">
                <h3>üîó Wallet Connection</h3>
                <div class="input-group">
                    <label>Status:</label>
                    <div id="walletStatus" class="disconnected">Not Connected</div>
                    <div id="walletAddress" style="font-size: 0.9em; margin-top: 5px; word-break: break-all;"></div>
                </div>
                <button id="connectWallet" class="btn">Connect Wallet</button>
            </div>

            <!-- Contract Interaction -->
            <div class="card">
                <h3>üìã Contract Info</h3>
                <div class="input-group">
                    <label>Contract Address:</label>
                    <input type="text" id="contractAddress" placeholder="Enter contract address" value="0xCd75d1d83BBfC8C6F4290Cc36866C83c95C67d60">
                </div>
                <button id="loadContract" class="btn">Load Contract</button>
                <div id="contractStatus" style="margin-top: 10px; font-size: 0.9em;"></div>
            </div>

            <!-- Registration -->
            <div class="card">
                <h3>üë§ Trader Registration</h3>
                <div class="input-group">
                    <label>Initial Balance (USD):</label>
                    <input type="number" id="initialBalance" placeholder="Enter initial balance" min="1" value="10000">
                </div>
                <button id="registerTrader" class="btn">Register as Trader</button>
                <div id="registrationStatus" style="margin-top: 10px; font-size: 0.9em;"></div>
            </div>

            <!-- Trading Session Status -->
            <div class="card status-card">
                <h3>üìä Current Trading Session</h3>
                <div class="status-grid">
                    <div class="status-item">
                        <strong>Session ID</strong>
                        <div id="currentSession">Loading...</div>
                    </div>
                    <div class="status-item">
                        <strong>Status</strong>
                        <div id="sessionStatus">Loading...</div>
                    </div>
                    <div class="status-item">
                        <strong>Active Traders</strong>
                        <div id="activeTraders">Loading...</div>
                    </div>
                    <div class="status-item">
                        <strong>Time Remaining</strong>
                        <div id="timeRemaining">Loading...</div>
                    </div>
                </div>
            </div>

            <!-- Currency Pairs -->
            <div class="card">
                <h3>üí± Currency Pairs</h3>
                <div class="currency-pairs">
                    <div class="pair-item">EUR/USD</div>
                    <div class="pair-item">GBP/USD</div>
                    <div class="pair-item">USD/JPY</div>
                    <div class="pair-item">AUD/USD</div>
                    <div class="pair-item">USD/CHF</div>
                </div>
            </div>

            <!-- Place Order -->
            <div class="card">
                <h3>üìà Place Private Order</h3>
                <div class="input-group">
                    <label>Currency Pair:</label>
                    <select id="currencyPair">
                        <option value="0">EUR/USD</option>
                        <option value="1">GBP/USD</option>
                        <option value="2">USD/JPY</option>
                        <option value="3">AUD/USD</option>
                        <option value="4">USD/CHF</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Trade Amount (USD):</label>
                    <input type="number" id="tradeAmount" placeholder="Enter amount" min="1" value="1000">
                </div>
                <div class="input-group">
                    <label>Target Price (scaled by 10000):</label>
                    <input type="number" id="targetPrice" placeholder="e.g., 12000 for 1.2000" min="1" value="11000">
                </div>
                <button id="placeOrder" class="btn">Place Private Order</button>
            </div>

            <!-- Trader Profile -->
            <div class="card">
                <h3>üë®‚Äçüíº My Profile</h3>
                <div id="traderProfile">
                    <div class="status-item">
                        <strong>Registration Status</strong>
                        <div id="isRegistered">Not Registered</div>
                    </div>
                    <div class="status-item">
                        <strong>Orders This Session</strong>
                        <div id="orderCount">0</div>
                    </div>
                    <div class="status-item">
                        <strong>Last Activity</strong>
                        <div id="lastActivity">Never</div>
                    </div>
                </div>
            </div>

            <!-- Admin Functions -->
            <div class="card">
                <h3>‚öôÔ∏è Admin Functions</h3>
                <div class="input-group">
                    <label>Forex Rates (scaled by 10000):</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                        <input type="number" id="eurUsd" placeholder="EUR/USD (e.g., 11000)" value="11000">
                        <input type="number" id="gbpUsd" placeholder="GBP/USD (e.g., 12500)" value="12500">
                        <input type="number" id="usdJpy" placeholder="USD/JPY (e.g., 1500)" value="1500">
                        <input type="number" id="audUsd" placeholder="AUD/USD (e.g., 6500)" value="6500">
                        <input type="number" id="usdChf" placeholder="USD/CHF (e.g., 9200)" value="9200">
                    </div>
                </div>
                <button id="startSession" class="btn">Start Trading Session</button>
                <button id="endSession" class="btn btn-secondary" style="margin-top: 10px;">Execute Orders & End Session</button>
            </div>

            <!-- Transaction History -->
            <div class="card transaction-history">
                <h3>üìú Recent Transactions</h3>
                <div class="transaction-list" id="transactionList">
                    <div class="transaction-item">
                        <strong>Welcome to Private Forex Trading Platform</strong><br>
                        <span style="opacity: 0.8;">Connect your wallet to start trading</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Contract ABI (simplified for the main functions)
        const CONTRACT_ABI = [
            "function isSessionActive() view returns (bool)",
            "function registerTrader(uint64 _initialBalance)",
            "function startTradingSession(uint32[5] memory _forexRates)",
            "function placePrivateOrder(uint64 _amount, uint32 _targetPrice, uint8 _currencyPairId)",
            "function executePrivateOrders()",
            "function getCurrentSessionInfo() view returns (uint32, bool, bool, uint256, uint256, uint256)",
            "function getTraderProfile(address trader) view returns (bool, uint256)",
            "function getTraderOrderCount(address trader) view returns (uint256)",
            "function owner() view returns (address)",
            "event SessionStarted(uint32 indexed session, uint256 startTime)",
            "event PrivateOrderPlaced(address indexed trader, uint32 indexed session, uint256 orderIndex)",
            "event OrderExecuted(address indexed trader, uint32 indexed session, uint256 orderIndex)",
            "event TraderRegistered(address indexed trader)"
        ];

        let provider = null;
        let signer = null;
        let contract = null;
        let userAddress = null;

        // Initialize the application
        async function init() {
            // Check if ethers.js is loaded
            if (typeof ethers === 'undefined') {
                showAlert('Failed to load ethers.js library. Please refresh the page.', 'error');
                return;
            }

            updateConnectionStatus();
            setInterval(updateSessionInfo, 10000); // Update every 10 seconds
        }

        // Show alert message
        function showAlert(message, type = 'info') {
            const alertContainer = document.getElementById('alertContainer');
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            alertContainer.appendChild(alertDiv);

            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }

        // Add transaction to history
        function addTransaction(title, details, hash = null) {
            const transactionList = document.getElementById('transactionList');
            const transactionDiv = document.createElement('div');
            transactionDiv.className = 'transaction-item';

            let hashLink = '';
            if (hash) {
                hashLink = `<br><a href="https://sepolia.etherscan.io/tx/${hash}" target="_blank" style="color: #FFD700; text-decoration: none;">View on Etherscan</a>`;
            }

            transactionDiv.innerHTML = `
                <strong>${title}</strong><br>
                <span style="opacity: 0.8;">${details}</span>
                ${hashLink}
                <div style="font-size: 0.8em; opacity: 0.6; margin-top: 5px;">${new Date().toLocaleString()}</div>
            `;

            transactionList.insertBefore(transactionDiv, transactionList.firstChild);

            // Keep only last 10 transactions
            const transactions = transactionList.children;
            if (transactions.length > 10) {
                transactionList.removeChild(transactions[transactions.length - 1]);
            }
        }

        // Connect wallet
        async function connectWallet() {
            try {
                if (typeof window.ethereum !== 'undefined') {
                    provider = new ethers.providers.Web3Provider(window.ethereum);
                    await provider.send("eth_requestAccounts", []);
                    signer = provider.getSigner();
                    userAddress = await signer.getAddress();

                    updateConnectionStatus();
                    showAlert('Wallet connected successfully!', 'success');
                    addTransaction('Wallet Connected', `Address: ${userAddress}`);

                    // Load trader profile if contract is loaded
                    if (contract) {
                        await loadTraderProfile();
                    }
                } else {
                    showAlert('Please install MetaMask!', 'error');
                }
            } catch (error) {
                console.error('Error connecting wallet:', error);
                showAlert('Error connecting wallet: ' + error.message, 'error');
            }
        }

        // Update connection status
        function updateConnectionStatus() {
            const statusElement = document.getElementById('walletStatus');
            const addressElement = document.getElementById('walletAddress');

            if (userAddress) {
                statusElement.textContent = 'Connected';
                statusElement.className = 'connected';
                addressElement.textContent = `Address: ${userAddress}`;
            } else {
                statusElement.textContent = 'Not Connected';
                statusElement.className = 'disconnected';
                addressElement.textContent = '';
            }
        }

        // Load contract
        async function loadContract() {
            try {
                const contractAddress = document.getElementById('contractAddress').value.trim();
                if (!contractAddress) {
                    showAlert('Please enter a contract address', 'error');
                    return;
                }

                if (!provider) {
                    showAlert('Please connect your wallet first', 'error');
                    return;
                }

                contract = new ethers.Contract(contractAddress, CONTRACT_ABI, signer || provider);

                // Test contract by calling a view function
                await contract.isSessionActive();

                document.getElementById('contractStatus').textContent = `Contract loaded: ${contractAddress}`;
                showAlert('Contract loaded successfully!', 'success');
                addTransaction('Contract Loaded', `Address: ${contractAddress}`);

                // Load session info and trader profile
                await updateSessionInfo();
                if (userAddress) {
                    await loadTraderProfile();
                }
            } catch (error) {
                console.error('Error loading contract:', error);
                showAlert('Error loading contract: ' + error.message, 'error');
                document.getElementById('contractStatus').textContent = 'Contract not loaded';
            }
        }

        // Register trader
        async function registerTrader() {
            try {
                if (!contract || !signer) {
                    showAlert('Please connect wallet and load contract first', 'error');
                    return;
                }

                const initialBalance = document.getElementById('initialBalance').value;
                if (!initialBalance || initialBalance <= 0) {
                    showAlert('Please enter a valid initial balance', 'error');
                    return;
                }

                const button = document.getElementById('registerTrader');
                button.disabled = true;
                button.innerHTML = '<span class="loading"></span> Registering...';

                const tx = await contract.registerTrader(initialBalance);
                showAlert('Registration transaction sent. Waiting for confirmation...', 'info');
                addTransaction('Registration Pending', `Initial Balance: $${initialBalance}`, tx.hash);

                await tx.wait();
                showAlert('Successfully registered as trader!', 'success');
                addTransaction('Registration Confirmed', `Initial Balance: $${initialBalance}`, tx.hash);

                await loadTraderProfile();
            } catch (error) {
                console.error('Error registering trader:', error);
                showAlert('Error registering trader: ' + error.message, 'error');
            } finally {
                const button = document.getElementById('registerTrader');
                button.disabled = false;
                button.textContent = 'Register as Trader';
            }
        }

        // Start trading session
        async function startTradingSession() {
            try {
                if (!contract || !signer) {
                    showAlert('Please connect wallet and load contract first', 'error');
                    return;
                }

                const rates = [
                    document.getElementById('eurUsd').value,
                    document.getElementById('gbpUsd').value,
                    document.getElementById('usdJpy').value,
                    document.getElementById('audUsd').value,
                    document.getElementById('usdChf').value
                ];

                if (rates.some(rate => !rate || rate <= 0)) {
                    showAlert('Please enter valid forex rates for all currency pairs', 'error');
                    return;
                }

                const button = document.getElementById('startSession');
                button.disabled = true;
                button.innerHTML = '<span class="loading"></span> Starting Session...';

                const tx = await contract.startTradingSession(rates);
                showAlert('Starting trading session. Waiting for confirmation...', 'info');
                addTransaction('Session Start Pending', 'Starting new trading session', tx.hash);

                await tx.wait();
                showAlert('Trading session started successfully!', 'success');
                addTransaction('Session Started', 'New trading session is now active', tx.hash);

                await updateSessionInfo();
            } catch (error) {
                console.error('Error starting session:', error);
                showAlert('Error starting session: ' + error.message, 'error');
            } finally {
                const button = document.getElementById('startSession');
                button.disabled = false;
                button.textContent = 'Start Trading Session';
            }
        }

        // Place private order
        async function placePrivateOrder() {
            try {
                if (!contract || !signer) {
                    showAlert('Please connect wallet and load contract first', 'error');
                    return;
                }

                const amount = document.getElementById('tradeAmount').value;
                const targetPrice = document.getElementById('targetPrice').value;
                const currencyPair = document.getElementById('currencyPair').value;

                if (!amount || amount <= 0) {
                    showAlert('Please enter a valid trade amount', 'error');
                    return;
                }

                if (!targetPrice || targetPrice <= 0) {
                    showAlert('Please enter a valid target price', 'error');
                    return;
                }

                const button = document.getElementById('placeOrder');
                button.disabled = true;
                button.innerHTML = '<span class="loading"></span> Placing Order...';

                const pairNames = ['EUR/USD', 'GBP/USD', 'USD/JPY', 'AUD/USD', 'USD/CHF'];

                const tx = await contract.placePrivateOrder(amount, targetPrice, currencyPair);
                showAlert('Private order placed. Waiting for confirmation...', 'info');
                addTransaction('Order Pending', `${pairNames[currencyPair]}: $${amount} at ${targetPrice}`, tx.hash);

                await tx.wait();
                showAlert('Private order placed successfully!', 'success');
                addTransaction('Order Confirmed', `${pairNames[currencyPair]}: $${amount} at ${targetPrice}`, tx.hash);

                await loadTraderProfile();
            } catch (error) {
                console.error('Error placing order:', error);
                showAlert('Error placing order: ' + error.message, 'error');
            } finally {
                const button = document.getElementById('placeOrder');
                button.disabled = false;
                button.textContent = 'Place Private Order';
            }
        }

        // Execute orders and end session
        async function executeOrders() {
            try {
                if (!contract || !signer) {
                    showAlert('Please connect wallet and load contract first', 'error');
                    return;
                }

                const button = document.getElementById('endSession');
                button.disabled = true;
                button.innerHTML = '<span class="loading"></span> Executing Orders...';

                const tx = await contract.executePrivateOrders();
                showAlert('Executing orders. Waiting for confirmation...', 'info');
                addTransaction('Order Execution Pending', 'Processing all private orders', tx.hash);

                await tx.wait();
                showAlert('Orders executed and session ended!', 'success');
                addTransaction('Orders Executed', 'All orders processed, session ended', tx.hash);

                await updateSessionInfo();
            } catch (error) {
                console.error('Error executing orders:', error);
                showAlert('Error executing orders: ' + error.message, 'error');
            } finally {
                const button = document.getElementById('endSession');
                button.disabled = false;
                button.textContent = 'Execute Orders & End Session';
            }
        }

        // Update session information
        async function updateSessionInfo() {
            try {
                if (!contract) return;

                const sessionInfo = await contract.getCurrentSessionInfo();
                const [sessionId, pricesSet, sessionActive, startTime, endTime, activeTraderCount] = sessionInfo;

                document.getElementById('currentSession').textContent = sessionId.toString();
                document.getElementById('activeTraders').textContent = activeTraderCount.toString();

                if (sessionActive) {
                    document.getElementById('sessionStatus').textContent = 'Active';

                    const now = Math.floor(Date.now() / 1000);
                    const remaining = endTime.toNumber() - now;

                    if (remaining > 0) {
                        const hours = Math.floor(remaining / 3600);
                        const minutes = Math.floor((remaining % 3600) / 60);
                        document.getElementById('timeRemaining').textContent = `${hours}h ${minutes}m`;
                    } else {
                        document.getElementById('timeRemaining').textContent = 'Ended';
                    }
                } else {
                    document.getElementById('sessionStatus').textContent = 'Inactive';
                    document.getElementById('timeRemaining').textContent = 'N/A';
                }
            } catch (error) {
                console.error('Error updating session info:', error);
            }
        }

        // Load trader profile
        async function loadTraderProfile() {
            try {
                if (!contract || !userAddress) return;

                const profile = await contract.getTraderProfile(userAddress);
                const [isRegistered, lastActivity] = profile;

                document.getElementById('isRegistered').textContent = isRegistered ? 'Registered' : 'Not Registered';

                if (lastActivity.toNumber() > 0) {
                    const date = new Date(lastActivity.toNumber() * 1000);
                    document.getElementById('lastActivity').textContent = date.toLocaleString();
                }

                if (isRegistered) {
                    const orderCount = await contract.getTraderOrderCount(userAddress);
                    document.getElementById('orderCount').textContent = orderCount.toString();
                }
            } catch (error) {
                console.error('Error loading trader profile:', error);
            }
        }

        // Event listeners
        document.getElementById('connectWallet').addEventListener('click', connectWallet);
        document.getElementById('loadContract').addEventListener('click', loadContract);
        document.getElementById('registerTrader').addEventListener('click', registerTrader);
        document.getElementById('startSession').addEventListener('click', startTradingSession);
        document.getElementById('placeOrder').addEventListener('click', placePrivateOrder);
        document.getElementById('endSession').addEventListener('click', executeOrders);

        // Initialize application when DOM is ready and ethers is loaded
        window.addEventListener('DOMContentLoaded', function() {
            // Check if ethers is already loaded
            if (typeof ethers !== 'undefined') {
                init();
            } else {
                // Wait a bit for ethers to load
                setTimeout(function() {
                    if (typeof ethers !== 'undefined') {
                        init();
                    } else {
                        console.error('Ethers.js failed to load');
                        showAlert('Failed to load required libraries. Please refresh the page.', 'error');
                    }
                }, 1000);
            }
        });
    </script>
</body>
</html>