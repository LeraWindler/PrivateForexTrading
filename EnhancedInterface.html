<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Private Forex Trading Platform</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .header h1 {
            font-size: 2.8em;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #FFD700, #FFA500);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header .subtitle {
            font-size: 1.2em;
            opacity: 0.9;
            margin-bottom: 10px;
        }

        .header .features {
            font-size: 0.9em;
            opacity: 0.7;
            margin-top: 10px;
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: rgba(255, 255, 255, 0.1);
            padding: 25px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .card.full-width {
            grid-column: 1 / -1;
        }

        .card.two-thirds {
            grid-column: span 2;
        }

        .card h3 {
            margin-bottom: 20px;
            color: #FFD700;
            font-size: 1.3em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 600;
            margin-left: auto;
        }

        .badge-success {
            background: rgba(40, 167, 69, 0.3);
            color: #28a745;
            border: 1px solid #28a745;
        }

        .badge-warning {
            background: rgba(255, 193, 7, 0.3);
            color: #ffc107;
            border: 1px solid #ffc107;
        }

        .badge-danger {
            background: rgba(220, 53, 69, 0.3);
            color: #dc3545;
            border: 1px solid #dc3545;
        }

        .badge-info {
            background: rgba(23, 162, 184, 0.3);
            color: #17a2b8;
            border: 1px solid #17a2b8;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            font-size: 0.95em;
        }

        .input-group input, .input-group select {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 16px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
        }

        .input-group input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: #FFD700;
            box-shadow: 0 0 0 3px rgba(255, 215, 0, 0.2);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            background: linear-gradient(45deg, #FFD700, #FFA500);
            color: #000;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 16px;
            width: 100%;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(255, 215, 0, 0.4);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: linear-gradient(45deg, #6c757d, #495057);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(45deg, #dc3545, #c82333);
            color: white;
        }

        .btn-success {
            background: linear-gradient(45deg, #28a745, #218838);
            color: white;
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .status-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            text-align: center;
        }

        .status-item strong {
            color: #FFD700;
            display: block;
            margin-bottom: 8px;
            font-size: 0.85em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .status-item .value {
            font-size: 1.4em;
            font-weight: 600;
        }

        .connected {
            color: #28a745;
        }

        .disconnected {
            color: #dc3545;
        }

        .alert {
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid;
            display: flex;
            align-items: center;
            gap: 10px;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .alert-success {
            background: rgba(40, 167, 69, 0.2);
            border-color: #28a745;
            color: #28a745;
        }

        .alert-error {
            background: rgba(220, 53, 69, 0.2);
            border-color: #dc3545;
            color: #dc3545;
        }

        .alert-info {
            background: rgba(23, 162, 184, 0.2);
            border-color: #17a2b8;
            color: #17a2b8;
        }

        .alert-warning {
            background: rgba(255, 193, 7, 0.2);
            border-color: #ffc107;
            color: #ffc107;
        }

        .transaction-list {
            max-height: 400px;
            overflow-y: auto;
            margin-top: 15px;
        }

        .transaction-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }

        .transaction-item:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateX(5px);
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #FFD700;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #FFD700, #FFA500);
            transition: width 0.3s ease;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .info-row:last-child {
            border-bottom: none;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .tab {
            flex: 1;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .tab.active {
            background: linear-gradient(45deg, #FFD700, #FFA500);
            color: #000;
            font-weight: bold;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        @media (max-width: 1200px) {
            .dashboard {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 2em;
            }

            .card.two-thirds {
                grid-column: span 1;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîê Enhanced Private Forex Trading Platform</h1>
            <div class="subtitle">Secure Currency Trading with Fully Homomorphic Encryption</div>
            <div class="features">
                ‚úì Gateway Callback Pattern | ‚úì Refund Protection | ‚úì Timeout Safety | ‚úì Privacy Obfuscation | ‚úì Gas Optimized
            </div>
        </div>

        <div id="alertContainer"></div>

        <div class="dashboard">
            <!-- Wallet Connection -->
            <div class="card">
                <h3>üîó Wallet Connection</h3>
                <div class="input-group">
                    <label>Status:</label>
                    <div id="walletStatus" class="disconnected value">Not Connected</div>
                    <div id="walletAddress" style="font-size: 0.85em; margin-top: 10px; word-break: break-all; opacity: 0.8;"></div>
                </div>
                <button id="connectWallet" class="btn">Connect Wallet</button>
            </div>

            <!-- Contract Info -->
            <div class="card two-thirds">
                <h3>üìã Contract Information</h3>
                <div class="input-group">
                    <label>Contract Address:</label>
                    <input type="text" id="contractAddress" placeholder="Enter enhanced contract address" value="">
                </div>
                <button id="loadContract" class="btn">Load Contract</button>
                <div id="contractStatus" style="margin-top: 15px; font-size: 0.9em;"></div>
            </div>

            <!-- Session Status -->
            <div class="card full-width">
                <h3>
                    üìä Trading Session Status
                    <span id="sessionBadge" class="badge badge-danger">Inactive</span>
                </h3>
                <div class="status-grid">
                    <div class="status-item">
                        <strong>Session ID</strong>
                        <div id="currentSession" class="value">-</div>
                    </div>
                    <div class="status-item">
                        <strong>Status</strong>
                        <div id="sessionStatus" class="value">-</div>
                    </div>
                    <div class="status-item">
                        <strong>Active Traders</strong>
                        <div id="activeTraders" class="value">-</div>
                    </div>
                    <div class="status-item">
                        <strong>Time Remaining</strong>
                        <div id="timeRemaining" class="value">-</div>
                    </div>
                    <div class="status-item">
                        <strong>Decryption Status</strong>
                        <div id="decryptionStatus" class="value">-</div>
                    </div>
                    <div class="status-item">
                        <strong>Emergency Refund</strong>
                        <div id="emergencyRefund" class="value">-</div>
                    </div>
                </div>
            </div>

            <!-- Trader Registration -->
            <div class="card">
                <h3>üë§ Trader Registration</h3>
                <div class="input-group">
                    <label>Initial Balance (minimum 1000):</label>
                    <input type="number" id="initialBalance" placeholder="Enter initial balance" min="1000" value="10000">
                </div>
                <button id="registerTrader" class="btn">Register as Trader</button>
                <div id="registrationInfo" style="margin-top: 15px; font-size: 0.85em; opacity: 0.8;">
                    ‚ÑπÔ∏è Registration enables encrypted trading with privacy protection
                </div>
            </div>

            <!-- Trader Profile -->
            <div class="card">
                <h3>üë®‚Äçüíº My Profile</h3>
                <div id="traderProfile">
                    <div class="info-row">
                        <span>Registration:</span>
                        <strong id="isRegistered" class="disconnected">Not Registered</strong>
                    </div>
                    <div class="info-row">
                        <span>Blacklist Status:</span>
                        <strong id="isBlacklisted">-</strong>
                    </div>
                    <div class="info-row">
                        <span>Orders (Current):</span>
                        <strong id="orderCount">0</strong>
                    </div>
                    <div class="info-row">
                        <span>Last Activity:</span>
                        <strong id="lastActivity">Never</strong>
                    </div>
                    <div class="info-row">
                        <span>Total Deposited:</span>
                        <strong id="totalDeposited">$0</strong>
                    </div>
                </div>
            </div>

            <!-- Place Order -->
            <div class="card">
                <h3>üìà Place Private Order</h3>
                <div class="input-group">
                    <label>Currency Pair:</label>
                    <select id="currencyPair">
                        <option value="0">EUR/USD</option>
                        <option value="1">GBP/USD</option>
                        <option value="2">USD/JPY</option>
                        <option value="3">AUD/USD</option>
                        <option value="4">USD/CHF</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Trade Amount:</label>
                    <input type="number" id="tradeAmount" placeholder="Enter amount" min="1" value="1000">
                </div>
                <div class="input-group">
                    <label>Target Price (scaled by 10000):</label>
                    <input type="number" id="targetPrice" placeholder="e.g., 12000 = 1.2000" min="1" value="11000">
                </div>
                <button id="placeOrder" class="btn">Place Encrypted Order</button>
                <div style="margin-top: 10px; font-size: 0.85em; opacity: 0.7;">
                    üîí Order uses privacy multipliers for amount obfuscation
                </div>
            </div>

            <!-- Decryption & Refund -->
            <div class="card two-thirds">
                <h3>üîì Gateway Decryption & Refunds</h3>
                <div class="tabs">
                    <div class="tab active" onclick="switchTab('decryption')">Decryption Request</div>
                    <div class="tab" onclick="switchTab('refund')">Emergency Refund</div>
                </div>

                <div id="decryption-tab" class="tab-content active">
                    <div class="input-group">
                        <label>Session ID to Decrypt:</label>
                        <input type="number" id="decryptSessionId" placeholder="Enter session ID" min="1">
                    </div>
                    <button id="requestDecryption" class="btn">Request Gateway Decryption</button>
                    <div style="margin-top: 15px; font-size: 0.85em; opacity: 0.8;">
                        ‚ÑπÔ∏è Gateway callback will process all encrypted orders asynchronously
                    </div>
                    <div id="decryptionRequestInfo" style="margin-top: 10px;"></div>
                </div>

                <div id="refund-tab" class="tab-content">
                    <div class="input-group">
                        <label>Session ID for Refund:</label>
                        <input type="number" id="refundSessionId" placeholder="Enter session ID" min="1">
                    </div>
                    <button id="enableRefund" class="btn btn-danger">Enable Emergency Refund (Admin)</button>
                    <button id="claimRefund" class="btn btn-success" style="margin-top: 10px;">Claim My Refund</button>
                    <div style="margin-top: 15px; font-size: 0.85em; opacity: 0.8;">
                        ‚ö†Ô∏è Emergency refunds available after 24hr timeout if Gateway fails
                    </div>
                </div>
            </div>

            <!-- Admin Functions -->
            <div class="card full-width">
                <h3>‚öôÔ∏è Admin Functions</h3>
                <div class="tabs">
                    <div class="tab active" onclick="switchTab('admin-session')">Session Management</div>
                    <div class="tab" onclick="switchTab('admin-blacklist')">Blacklist</div>
                    <div class="tab" onclick="switchTab('admin-fees')">Platform Fees</div>
                </div>

                <div id="admin-session-tab" class="tab-content active">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                        <div>
                            <div class="input-group">
                                <label>Session Duration (seconds):</label>
                                <input type="number" id="sessionDuration" placeholder="e.g., 14400 (4 hours)" value="14400" min="300" max="2592000">
                            </div>
                            <div class="input-group">
                                <label>Forex Rates (scaled by 10000):</label>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                    <input type="number" id="eurUsd" placeholder="EUR/USD" value="11000">
                                    <input type="number" id="gbpUsd" placeholder="GBP/USD" value="12500">
                                    <input type="number" id="usdJpy" placeholder="USD/JPY" value="1500">
                                    <input type="number" id="audUsd" placeholder="AUD/USD" value="6500">
                                    <input type="number" id="usdChf" placeholder="USD/CHF" value="9200">
                                </div>
                            </div>
                            <button id="startSession" class="btn">Start Trading Session</button>
                        </div>
                        <div>
                            <button id="endSession" class="btn btn-secondary">Emergency End Session</button>
                            <div style="margin-top: 10px; font-size: 0.85em; opacity: 0.7;">
                                ‚ö†Ô∏è Emergency end immediately closes the session
                            </div>
                        </div>
                    </div>
                </div>

                <div id="admin-blacklist-tab" class="tab-content">
                    <div class="input-group">
                        <label>Trader Address:</label>
                        <input type="text" id="blacklistAddress" placeholder="0x...">
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <button id="addBlacklist" class="btn btn-danger">Blacklist Trader</button>
                        <button id="removeBlacklist" class="btn btn-success">Remove from Blacklist</button>
                    </div>
                </div>

                <div id="admin-fees-tab" class="tab-content">
                    <div class="status-grid">
                        <div class="status-item">
                            <strong>Platform Fees</strong>
                            <div id="platformFees" class="value">-</div>
                        </div>
                        <div class="status-item">
                            <strong>Fee Rate</strong>
                            <div class="value">0.1% (10 BPS)</div>
                        </div>
                    </div>
                    <button id="withdrawFees" class="btn" style="margin-top: 20px;">Withdraw Platform Fees</button>
                </div>
            </div>

            <!-- Transaction History -->
            <div class="card full-width">
                <h3>üìú Transaction History</h3>
                <div class="transaction-list" id="transactionList">
                    <div class="transaction-item">
                        <strong>Welcome to Enhanced Private Forex Trading</strong><br>
                        <span style="opacity: 0.8;">Connect your wallet to start trading with privacy protection</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Enhanced Contract ABI
        const CONTRACT_ABI = [
            "function isSessionActive() view returns (bool)",
            "function registerTrader(uint64 _initialBalance)",
            "function startTradingSession(uint32[5] memory _forexRates, uint256 _duration)",
            "function placePrivateOrder(uint64 _amount, uint32 _targetPrice, uint8 _currencyPairId)",
            "function requestOrderDecryption(uint32 _sessionId)",
            "function enableEmergencyRefund(uint32 sessionId)",
            "function claimDecryptionFailureRefund(uint32 sessionId)",
            "function setTraderBlacklist(address trader, bool status)",
            "function withdrawPlatformFees()",
            "function emergencyEndSession()",
            "function getCurrentSessionInfo() view returns (uint32, bool, bool, uint256, uint256, uint256, uint256, bool, bool)",
            "function getTraderProfile(address trader) view returns (bool, bool, uint256, uint256, uint256)",
            "function getTraderOrderCount(address trader) view returns (uint256)",
            "function getDecryptionRequestStatus(uint256 requestId) view returns (uint32, address, uint256, bool, bool)",
            "function isDecryptionPending(uint32 sessionId) view returns (bool)",
            "function getPlatformStats() view returns (uint256, uint256, uint256)",
            "function owner() view returns (address)",
            "event SessionStarted(uint32 indexed session, uint256 startTime, uint256 endTime)",
            "event PrivateOrderPlaced(address indexed trader, uint32 indexed session, uint256 orderIndex)",
            "event DecryptionRequested(uint32 indexed session, uint256 requestId)",
            "event DecryptionCompleted(uint32 indexed session, uint256 requestId)",
            "event DecryptionFailed(uint32 indexed session, uint256 requestId)",
            "event RefundIssued(address indexed trader, uint32 indexed session, uint256 amount)",
            "event EmergencyRefundEnabled(uint32 indexed session)",
            "event TraderRegistered(address indexed trader)"
        ];

        let provider = null;
        let signer = null;
        let contract = null;
        let userAddress = null;
        let updateInterval = null;

        // Initialize
        async function init() {
            if (typeof ethers === 'undefined') {
                showAlert('Failed to load ethers.js library. Please refresh the page.', 'error');
                return;
            }

            updateConnectionStatus();

            // Auto-connect if previously connected
            if (window.ethereum && window.ethereum.selectedAddress) {
                await connectWallet();
            }
        }

        // Switch tabs
        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });

            const contentId = tabName + '-tab';
            const content = document.getElementById(contentId);
            if (content) {
                content.classList.add('active');
            }
        }

        // Show alert
        function showAlert(message, type = 'info') {
            const alertContainer = document.getElementById('alertContainer');
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            alertContainer.appendChild(alertDiv);

            setTimeout(() => alertDiv.remove(), 7000);
        }

        // Add transaction
        function addTransaction(title, details, hash = null) {
            const transactionList = document.getElementById('transactionList');
            const transactionDiv = document.createElement('div');
            transactionDiv.className = 'transaction-item';

            let hashLink = '';
            if (hash) {
                hashLink = `<br><a href="https://sepolia.etherscan.io/tx/${hash}" target="_blank" style="color: #FFD700; text-decoration: none;">View on Etherscan ‚Üí</a>`;
            }

            transactionDiv.innerHTML = `
                <strong>${title}</strong><br>
                <span style="opacity: 0.8;">${details}</span>
                ${hashLink}
                <div style="font-size: 0.8em; opacity: 0.6; margin-top: 5px;">${new Date().toLocaleString()}</div>
            `;

            transactionList.insertBefore(transactionDiv, transactionList.firstChild);

            if (transactionList.children.length > 15) {
                transactionList.removeChild(transactionList.lastChild);
            }
        }

        // Connect wallet
        async function connectWallet() {
            try {
                if (typeof window.ethereum !== 'undefined') {
                    provider = new ethers.providers.Web3Provider(window.ethereum);
                    await provider.send("eth_requestAccounts", []);
                    signer = provider.getSigner();
                    userAddress = await signer.getAddress();

                    updateConnectionStatus();
                    showAlert('Wallet connected successfully!', 'success');
                    addTransaction('Wallet Connected', `Address: ${userAddress}`);

                    if (contract) {
                        await loadTraderProfile();
                    }
                } else {
                    showAlert('Please install MetaMask!', 'error');
                }
            } catch (error) {
                console.error('Error connecting wallet:', error);
                showAlert('Error connecting wallet: ' + error.message, 'error');
            }
        }

        // Update connection status
        function updateConnectionStatus() {
            const statusElement = document.getElementById('walletStatus');
            const addressElement = document.getElementById('walletAddress');

            if (userAddress) {
                statusElement.textContent = 'Connected';
                statusElement.className = 'connected value';
                addressElement.textContent = `${userAddress.slice(0, 6)}...${userAddress.slice(-4)}`;
            } else {
                statusElement.textContent = 'Not Connected';
                statusElement.className = 'disconnected value';
                addressElement.textContent = '';
            }
        }

        // Load contract
        async function loadContract() {
            try {
                const contractAddress = document.getElementById('contractAddress').value.trim();
                if (!contractAddress) {
                    showAlert('Please enter a contract address', 'error');
                    return;
                }

                if (!provider) {
                    showAlert('Please connect your wallet first', 'error');
                    return;
                }

                contract = new ethers.Contract(contractAddress, CONTRACT_ABI, signer || provider);
                await contract.isSessionActive();

                document.getElementById('contractStatus').textContent = `‚úì Contract loaded: ${contractAddress}`;
                showAlert('Contract loaded successfully!', 'success');
                addTransaction('Contract Loaded', `Address: ${contractAddress}`);

                await updateSessionInfo();
                if (userAddress) {
                    await loadTraderProfile();
                }

                // Start auto-update
                if (updateInterval) clearInterval(updateInterval);
                updateInterval = setInterval(updateSessionInfo, 10000);

                // Listen for events
                setupEventListeners();
            } catch (error) {
                console.error('Error loading contract:', error);
                showAlert('Error loading contract: ' + error.message, 'error');
                document.getElementById('contractStatus').textContent = '‚úó Contract not loaded';
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            contract.on("DecryptionRequested", (sessionId, requestId) => {
                showAlert(`Decryption requested for session ${sessionId}`, 'info');
                addTransaction('Decryption Requested', `Session ${sessionId}, Request ${requestId}`);
            });

            contract.on("DecryptionCompleted", (sessionId, requestId) => {
                showAlert(`Decryption completed for session ${sessionId}`, 'success');
                addTransaction('Decryption Completed', `Session ${sessionId} orders decrypted`);
                updateSessionInfo();
            });

            contract.on("DecryptionFailed", (sessionId, requestId) => {
                showAlert(`Decryption failed for session ${sessionId}. Emergency refund available.`, 'warning');
                addTransaction('Decryption Failed', `Session ${sessionId} - Refund available`);
            });

            contract.on("EmergencyRefundEnabled", (sessionId) => {
                showAlert(`Emergency refund enabled for session ${sessionId}`, 'warning');
                addTransaction('Emergency Refund Enabled', `Session ${sessionId}`);
                updateSessionInfo();
            });
        }

        // Register trader
        async function registerTrader() {
            try {
                if (!contract || !signer) {
                    showAlert('Please connect wallet and load contract first', 'error');
                    return;
                }

                const initialBalance = document.getElementById('initialBalance').value;
                if (!initialBalance || initialBalance < 1000) {
                    showAlert('Minimum initial balance is 1000', 'error');
                    return;
                }

                const button = document.getElementById('registerTrader');
                button.disabled = true;
                button.innerHTML = '<span class="loading"></span> Registering...';

                const tx = await contract.registerTrader(initialBalance);
                showAlert('Registration transaction sent...', 'info');
                addTransaction('Registration Pending', `Initial Balance: $${initialBalance}`, tx.hash);

                await tx.wait();
                showAlert('Successfully registered as trader!', 'success');
                addTransaction('Registration Confirmed', `Initial Balance: $${initialBalance}`, tx.hash);

                await loadTraderProfile();
            } catch (error) {
                console.error('Error:', error);
                showAlert('Error: ' + error.message, 'error');
            } finally {
                const button = document.getElementById('registerTrader');
                button.disabled = false;
                button.textContent = 'Register as Trader';
            }
        }

        // Place order
        async function placePrivateOrder() {
            try {
                if (!contract || !signer) {
                    showAlert('Please connect wallet and load contract first', 'error');
                    return;
                }

                const amount = document.getElementById('tradeAmount').value;
                const targetPrice = document.getElementById('targetPrice').value;
                const currencyPair = document.getElementById('currencyPair').value;

                if (!amount || amount <= 0 || !targetPrice || targetPrice <= 0) {
                    showAlert('Please enter valid amounts', 'error');
                    return;
                }

                const button = document.getElementById('placeOrder');
                button.disabled = true;
                button.innerHTML = '<span class="loading"></span> Placing Order...';

                const pairNames = ['EUR/USD', 'GBP/USD', 'USD/JPY', 'AUD/USD', 'USD/CHF'];
                const tx = await contract.placePrivateOrder(amount, targetPrice, currencyPair);

                showAlert('Private order placed. Waiting for confirmation...', 'info');
                addTransaction('Order Pending', `${pairNames[currencyPair]}: $${amount} at ${targetPrice}`, tx.hash);

                await tx.wait();
                showAlert('Order placed with privacy protection!', 'success');
                addTransaction('Order Confirmed', `${pairNames[currencyPair]}: Amount obfuscated`, tx.hash);

                await loadTraderProfile();
            } catch (error) {
                console.error('Error:', error);
                showAlert('Error: ' + error.message, 'error');
            } finally {
                const button = document.getElementById('placeOrder');
                button.disabled = false;
                button.textContent = 'Place Encrypted Order';
            }
        }

        // Update session info
        async function updateSessionInfo() {
            try {
                if (!contract) return;

                const sessionInfo = await contract.getCurrentSessionInfo();
                const [sessionId, pricesSet, sessionActive, startTime, endTime, decryptionDeadline,
                       activeTraderCount, decryptionComplete, emergencyRefundEnabled] = sessionInfo;

                document.getElementById('currentSession').textContent = sessionId.toString();
                document.getElementById('activeTraders').textContent = activeTraderCount.toString();

                const badge = document.getElementById('sessionBadge');
                if (sessionActive) {
                    document.getElementById('sessionStatus').textContent = 'Active';
                    badge.textContent = 'Active';
                    badge.className = 'badge badge-success';

                    const now = Math.floor(Date.now() / 1000);
                    const remaining = endTime.toNumber() - now;

                    if (remaining > 0) {
                        const hours = Math.floor(remaining / 3600);
                        const minutes = Math.floor((remaining % 3600) / 60);
                        document.getElementById('timeRemaining').textContent = `${hours}h ${minutes}m`;
                    } else {
                        document.getElementById('timeRemaining').textContent = 'Ended';
                    }
                } else {
                    document.getElementById('sessionStatus').textContent = 'Inactive';
                    document.getElementById('timeRemaining').textContent = 'N/A';
                    badge.textContent = 'Inactive';
                    badge.className = 'badge badge-danger';
                }

                document.getElementById('decryptionStatus').textContent = decryptionComplete ? 'Complete' : 'Pending';
                document.getElementById('emergencyRefund').textContent = emergencyRefundEnabled ? 'Enabled' : 'Disabled';
            } catch (error) {
                console.error('Error updating session:', error);
            }
        }

        // Load trader profile
        async function loadTraderProfile() {
            try {
                if (!contract || !userAddress) return;

                const profile = await contract.getTraderProfile(userAddress);
                const [isRegistered, isBlacklisted, lastActivity, totalDeposited, totalWithdrawn] = profile;

                document.getElementById('isRegistered').textContent = isRegistered ? 'Registered' : 'Not Registered';
                document.getElementById('isRegistered').className = isRegistered ? 'connected' : 'disconnected';

                document.getElementById('isBlacklisted').textContent = isBlacklisted ? 'Yes' : 'No';
                document.getElementById('totalDeposited').textContent = `$${totalDeposited}`;

                if (lastActivity.toNumber() > 0) {
                    const date = new Date(lastActivity.toNumber() * 1000);
                    document.getElementById('lastActivity').textContent = date.toLocaleString();
                }

                if (isRegistered) {
                    const orderCount = await contract.getTraderOrderCount(userAddress);
                    document.getElementById('orderCount').textContent = orderCount.toString();
                }
            } catch (error) {
                console.error('Error loading profile:', error);
            }
        }

        // Event listeners
        document.getElementById('connectWallet').addEventListener('click', connectWallet);
        document.getElementById('loadContract').addEventListener('click', loadContract);
        document.getElementById('registerTrader').addEventListener('click', registerTrader);
        document.getElementById('placeOrder').addEventListener('click', placePrivateOrder);

        document.getElementById('startSession').addEventListener('click', async () => {
            try {
                const duration = document.getElementById('sessionDuration').value;
                const rates = [
                    document.getElementById('eurUsd').value,
                    document.getElementById('gbpUsd').value,
                    document.getElementById('usdJpy').value,
                    document.getElementById('audUsd').value,
                    document.getElementById('usdChf').value
                ];

                if (rates.some(rate => !rate || rate <= 0)) {
                    showAlert('Please enter valid forex rates', 'error');
                    return;
                }

                const tx = await contract.startTradingSession(rates, duration);
                showAlert('Starting session with timeout protection...', 'info');
                await tx.wait();
                showAlert('Session started successfully!', 'success');
                await updateSessionInfo();
            } catch (error) {
                showAlert('Error: ' + error.message, 'error');
            }
        });

        document.getElementById('requestDecryption').addEventListener('click', async () => {
            try {
                const sessionId = document.getElementById('decryptSessionId').value;
                if (!sessionId) {
                    showAlert('Please enter session ID', 'error');
                    return;
                }

                const tx = await contract.requestOrderDecryption(sessionId);
                showAlert('Gateway decryption requested...', 'info');
                await tx.wait();
                showAlert('Decryption request sent to Gateway!', 'success');
            } catch (error) {
                showAlert('Error: ' + error.message, 'error');
            }
        });

        document.getElementById('enableRefund').addEventListener('click', async () => {
            try {
                const sessionId = document.getElementById('refundSessionId').value;
                const tx = await contract.enableEmergencyRefund(sessionId);
                await tx.wait();
                showAlert('Emergency refund enabled!', 'success');
            } catch (error) {
                showAlert('Error: ' + error.message, 'error');
            }
        });

        document.getElementById('claimRefund').addEventListener('click', async () => {
            try {
                const sessionId = document.getElementById('refundSessionId').value;
                const tx = await contract.claimDecryptionFailureRefund(sessionId);
                await tx.wait();
                showAlert('Refund claimed successfully!', 'success');
            } catch (error) {
                showAlert('Error: ' + error.message, 'error');
            }
        });

        document.getElementById('endSession').addEventListener('click', async () => {
            try {
                const tx = await contract.emergencyEndSession();
                await tx.wait();
                showAlert('Session ended!', 'success');
                await updateSessionInfo();
            } catch (error) {
                showAlert('Error: ' + error.message, 'error');
            }
        });

        document.getElementById('addBlacklist').addEventListener('click', async () => {
            try {
                const address = document.getElementById('blacklistAddress').value;
                const tx = await contract.setTraderBlacklist(address, true);
                await tx.wait();
                showAlert('Trader blacklisted!', 'success');
            } catch (error) {
                showAlert('Error: ' + error.message, 'error');
            }
        });

        document.getElementById('removeBlacklist').addEventListener('click', async () => {
            try {
                const address = document.getElementById('blacklistAddress').value;
                const tx = await contract.setTraderBlacklist(address, false);
                await tx.wait();
                showAlert('Trader removed from blacklist!', 'success');
            } catch (error) {
                showAlert('Error: ' + error.message, 'error');
            }
        });

        document.getElementById('withdrawFees').addEventListener('click', async () => {
            try {
                const tx = await contract.withdrawPlatformFees();
                await tx.wait();
                showAlert('Fees withdrawn!', 'success');
            } catch (error) {
                showAlert('Error: ' + error.message, 'error');
            }
        });

        // Initialize on load
        window.addEventListener('DOMContentLoaded', () => {
            if (typeof ethers !== 'undefined') {
                init();
            } else {
                setTimeout(() => {
                    if (typeof ethers !== 'undefined') {
                        init();
                    } else {
                        showAlert('Failed to load required libraries. Please refresh.', 'error');
                    }
                }, 1000);
            }
        });
    </script>
</body>
</html>
